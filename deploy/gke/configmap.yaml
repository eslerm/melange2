# Copyright 2024 Chainguard, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: ConfigMap
metadata:
  name: melange-config
  namespace: melange
data:
  # GCS bucket for build artifacts and logs
  # Will be replaced by setup script
  gcs-bucket: "melange-builds"

  # Registry cache configuration
  # Uses in-cluster registry for BuildKit cache-to/cache-from
  cache-registry: "registry:5000/melange-cache"
  cache-mode: "max"

  # Apko base image cache configuration
  # Caches apko-generated base images in the in-cluster registry.
  # This significantly speeds up builds by allowing BuildKit to use
  # llb.Image() instead of extracting layers to disk.
  apko-registry: "registry:5000/apko-cache"
  apko-registry-insecure: "true"

  # Apko service configuration
  # When set, apko layer generation is delegated to the apko-server service.
  # This provides fault isolation and independent scaling.
  apko-service-addr: "apko-server:9090"
  apko-max-concurrent: "16"

  # Scaling configuration for large builds
  # Max concurrent GCS uploads (default: 200, was 50)
  max-concurrent-uploads: "200"
  # Scheduler poll interval (increase for thousands of packages)
  poll-interval: "2s"

  # APK disk cache configuration
  # Directory for caching downloaded APK packages
  # Using /tmp since container runs as non-root
  apk-cache-dir: "/tmp/apk-cache"
  # TTL for cached APK files (files older than this are evicted)
  # Set to 30m for aggressive cleanup during bulk builds
  apk-cache-ttl: "30m"

  # Observability configuration
  # OTLP endpoint for trace export (e.g., "tempo:4317")
  # Leave empty to use stdout exporter
  otlp-endpoint: ""
  # Allow insecure OTLP connections (no TLS)
  otlp-insecure: "true"
  # Trace sampling rate (0.0-1.0, default 0.1 for production)
  trace-sample-rate: "0.1"
  # Enable Prometheus metrics endpoint
  enable-metrics: "true"

  # BuildKit backends configuration
  # 15 BuildKit workers using StatefulSet DNS names
  # Each worker can handle 16 concurrent jobs (matching 16-core machines)
  # Total capacity: 15 Ã— 16 = 240 concurrent package builds
  backends.yaml: |
    backends:
      - addr: tcp://buildkit-0.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-1.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-2.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-3.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-4.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-5.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-6.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-7.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-8.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-9.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-10.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-11.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-12.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-13.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
      - addr: tcp://buildkit-14.buildkit-headless.melange.svc.cluster.local:1234
        arch: x86_64
        maxJobs: 16
        labels:
          tier: standard
    # Pool-wide configuration
    defaultMaxJobs: 16       # Default max concurrent jobs per backend
    failureThreshold: 5      # Consecutive failures before circuit opens (increased for scale)
    recoveryTimeout: 30s     # How long circuit stays open
