name: Test a python package import

needs:
  packages:
    - wolfi-base

inputs:
  python:
    description: Which python to use
    default: DEFAULT
  imports:
    description: |
      Commands to import packages, each line is a separate command. Example:
        from libfoo import bar
        # test that otherthing can be imported from asdf
        from asdf import otherthing
        import bark # this is like woof

      full-line and inline comments are supported via '#'
    required: true

pipeline:
  - runs: |
      set +x
      PYTHON="${{inputs.python}}"
      IMPORTS="${{inputs.imports}}"

      perform_import() {
        command="$1"
        if $PYTHON -c "$command"; then
          echo "$PYTHON -c \"$command\": PASS"
        else
          echo "$PYTHON -c \"$command\": FAIL"
          return 1
        fi
      }

      if [ "$PYTHON" = "DEFAULT" ]; then
          glob="/usr/bin/python3.[0-9][0-9] /usr/bin/python3.[789]"
          n=0
          for p in $glob; do
            [ -x "$p" ] && n=$((n+1)) && py=$p
          done
          if [ "$n" -ne 1 ]; then
            echo "FAIL: must set inputs.python: " \
               "found $n executables matching $glob"
            [ "$n" -eq 0 ] || echo "found:" $glob
            exit 1
          fi
          echo "using python $py"
          PYTHON=$py
      fi

      if [ -z "$IMPORTS" ]; then
        echo "No imports specified."
        exit 1
      fi

      fail_flag=0
      importf=$(mktemp) || { echo "failed mktemp"; exit 1; }
      printf "%s\n" "$IMPORTS" > "$importf" ||
          { echo "failed to write to temp file"; exit 1; }

      while read line; do
        # Drop anything after #
        line=${line%%#*}
        cmd=$(set -f; echo $line) # normalize/trim whitespace
        [ -z "$cmd" ] && continue
        perform_import "$cmd" || fail_flag=1
      done < "$importf"
      rm -f "$importf"

      exit $fail_flag
