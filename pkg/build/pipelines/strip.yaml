name: Strip binaries

needs:
  packages:
    - binutils
    - scanelf

inputs:
  opts:
    description: |
      The option flags to pass to the strip command.
    default: -g

pipeline:
  - working-directory: ${{targets.contextdir}}
    runs: |
      scanelf --recursive --nobanner --osabi --etype "ET_DYN,ET_EXEC" . \
        | while read type osabi filename; do

        [ "$osabi" != "STANDALONE" ] || continue
        # scanelf may have picked up a temp file so verify that file still exists
        # Ensure file is writable before stripping (needed when running as non-root)
        [ ! -e "$filename" ] && continue
        chmod u+w "${filename}" 2>/dev/null || true
        strip ${{inputs.opts}} "${filename}" || [ ! -e "$filename" ]
      done
