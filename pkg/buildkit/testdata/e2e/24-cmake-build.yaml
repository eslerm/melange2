package:
  name: cmake-test
  version: 2.0.0
  epoch: 0
  description: Test CMake-style build workflow
  copyright:
    - license: Apache-2.0

vars:
  cmake-opts: "-DENABLE_TESTS=OFF -DBUILD_SHARED_LIBS=ON"
  output-dir: "build"

pipeline:
  # Simulate cmake/configure step
  - name: cmake-configure
    runs: |
      mkdir -p ${{targets.destdir}}/usr/share/cmake-test

      # Record CMake configure step
      cat > ${{targets.destdir}}/usr/share/cmake-test/cmake-configure.log << 'CMAKE_EOF'
      CMake configure command:
        cmake -B build -G Ninja
        -DCMAKE_INSTALL_PREFIX=/usr
        -DCMAKE_INSTALL_LIBDIR=lib
        -DCMAKE_BUILD_TYPE=Release
        -DCMAKE_VERBOSE_MAKEFILE=ON
      CMAKE_EOF

      # Record custom CMake options
      echo "Custom options: ${{vars.cmake-opts}}" >> ${{targets.destdir}}/usr/share/cmake-test/cmake-configure.log

      # Simulate CMake cache generation
      mkdir -p ${{targets.destdir}}/usr/share/cmake-test/${{vars.output-dir}}
      cat > ${{targets.destdir}}/usr/share/cmake-test/${{vars.output-dir}}/CMakeCache.txt << 'CACHE_EOF'
      # CMakeCache.txt generated by CMake
      CMAKE_INSTALL_PREFIX:PATH=/usr
      CMAKE_INSTALL_LIBDIR:PATH=lib
      CMAKE_BUILD_TYPE:STRING=Release
      ENABLE_TESTS:BOOL=OFF
      BUILD_SHARED_LIBS:BOOL=ON
      CACHE_EOF

      echo "configure-done" > ${{targets.destdir}}/usr/share/cmake-test/status.txt

  # Simulate cmake/build step
  - name: cmake-build
    runs: |
      # Record CMake build step
      echo "Running: VERBOSE=1 cmake --build ${{vars.output-dir}}" >> ${{targets.destdir}}/usr/share/cmake-test/cmake-build.log

      # Simulate build artifacts
      mkdir -p ${{targets.destdir}}/usr/share/cmake-test/${{vars.output-dir}}/src
      echo "compiled-binary" > ${{targets.destdir}}/usr/share/cmake-test/${{vars.output-dir}}/src/cmake-test
      echo "compiled-library" > ${{targets.destdir}}/usr/share/cmake-test/${{vars.output-dir}}/src/libcmake-test.so.2.0.0

      echo "build-done" >> ${{targets.destdir}}/usr/share/cmake-test/status.txt

  # Simulate cmake/install step
  - name: cmake-install
    runs: |
      # Record CMake install step
      echo "Running: DESTDIR=${{targets.destdir}} cmake --install ${{vars.output-dir}}" >> ${{targets.destdir}}/usr/share/cmake-test/cmake-install.log

      # Create standard installation directories
      mkdir -p ${{targets.destdir}}/usr/bin
      mkdir -p ${{targets.destdir}}/usr/lib
      mkdir -p ${{targets.destdir}}/usr/include/cmake-test
      mkdir -p ${{targets.destdir}}/usr/lib/cmake/cmake-test

      # Simulate installed binary
      echo '#!/bin/sh' > ${{targets.destdir}}/usr/bin/cmake-test
      echo 'echo "CMake Test v${{package.version}}"' >> ${{targets.destdir}}/usr/bin/cmake-test
      chmod +x ${{targets.destdir}}/usr/bin/cmake-test

      # Simulate installed library
      echo "library-content" > ${{targets.destdir}}/usr/lib/libcmake-test.so.${{package.version}}

      # Simulate library symlinks
      echo "symlink: libcmake-test.so -> libcmake-test.so.${{package.version}}" > ${{targets.destdir}}/usr/lib/libcmake-test.symlink.txt

      # Simulate installed header
      cat > ${{targets.destdir}}/usr/include/cmake-test/cmake-test.h << 'HEADER_EOF'
      #ifndef CMAKE_TEST_H
      #define CMAKE_TEST_H

      #define CMAKE_TEST_VERSION_MAJOR 2
      #define CMAKE_TEST_VERSION_MINOR 0
      #define CMAKE_TEST_VERSION_PATCH 0

      void cmake_test_init(void);
      void cmake_test_cleanup(void);

      #endif
      HEADER_EOF

      # Simulate CMake config files
      cat > ${{targets.destdir}}/usr/lib/cmake/cmake-test/cmake-testConfig.cmake << 'CONFIG_EOF'
      # CMake package config file
      set(CMAKE_TEST_VERSION "2.0.0")
      set(CMAKE_TEST_INCLUDE_DIRS "/usr/include/cmake-test")
      set(CMAKE_TEST_LIBRARIES "/usr/lib/libcmake-test.so")
      CONFIG_EOF

      echo "install-done" >> ${{targets.destdir}}/usr/share/cmake-test/status.txt
