package:
  name: isolation-test
  version: 1.0.0
  epoch: 0
  description: Test subpackage test isolation - each subpackage should run in a fresh container

pipeline: []

# Main package test - creates a marker file
test:
  pipeline:
    - name: create-main-marker
      runs: |
        mkdir -p /home/build/markers
        echo "main-package-executed" > /home/build/markers/main.txt
        # Also create a "contamination" file that should NOT be visible to subpackages
        echo "contamination-from-main" > /tmp/contamination.txt

subpackages:
  - name: isolation-test-sub1
    pipeline: []
    test:
      pipeline:
        - name: check-isolation-from-main
          runs: |
            # This file should NOT exist - if it does, isolation is broken
            if [ -f /tmp/contamination.txt ]; then
              echo "ERROR: Isolation broken - contamination.txt from main package exists"
              exit 1
            fi
            # Main marker should also not exist in our workspace
            if [ -f /home/build/markers/main.txt ]; then
              echo "ERROR: Isolation broken - main.txt marker exists"
              exit 1
            fi
            echo "Isolation check passed for sub1"
        - name: create-sub1-marker
          runs: |
            mkdir -p /home/build/markers
            echo "sub1-executed" > /home/build/markers/sub1.txt
            # Create contamination for next subpackage
            echo "contamination-from-sub1" > /tmp/sub1-contamination.txt

  - name: isolation-test-sub2
    pipeline: []
    test:
      pipeline:
        - name: check-isolation-from-sub1
          runs: |
            # Files from sub1 should NOT exist
            if [ -f /tmp/sub1-contamination.txt ]; then
              echo "ERROR: Isolation broken - contamination.txt from sub1 exists"
              exit 1
            fi
            if [ -f /home/build/markers/sub1.txt ]; then
              echo "ERROR: Isolation broken - sub1.txt marker exists"
              exit 1
            fi
            echo "Isolation check passed for sub2"
        - name: create-sub2-marker
          runs: |
            mkdir -p /home/build/markers
            echo "sub2-executed" > /home/build/markers/sub2.txt
