package:
  name: go-build-test
  version: 3.1.4
  epoch: 1
  description: Test Go build workflow
  copyright:
    - license: BSD-3-Clause

vars:
  go-package: "go"
  ldflags: "-X main.version=${{package.version}} -X main.commit=abc123"
  tags: "json,netgo"
  modroot: "."
  output: "go-build-test"

pipeline:
  # Simulate go/build step
  - name: go-build
    runs: |
      mkdir -p ${{targets.destdir}}/usr/share/go-build-test

      # Record Go build command
      cat > ${{targets.destdir}}/usr/share/go-build-test/go-build.log << 'BUILD_EOF'
      Go build configuration:
        GOMODCACHE=/var/cache/melange/gomodcache
        GOAMD64=v2
        GOARM64=v8.0

      Build command:
        go build -o /home/build/usr/bin/go-build-test \
          -tags "netgo,osusergo,json,netgo" \
          -ldflags "-w -X main.version=3.1.4 -X main.commit=abc123" \
          -trimpath \
          -buildmode default \
          ./cmd/...
      BUILD_EOF

      # Record ldflags
      echo "LDFLAGS: ${{vars.ldflags}}" >> ${{targets.destdir}}/usr/share/go-build-test/go-build.log
      echo "TAGS: ${{vars.tags}}" >> ${{targets.destdir}}/usr/share/go-build-test/go-build.log

      # Simulate Go binary creation
      mkdir -p ${{targets.destdir}}/usr/bin
      echo '#!/bin/sh' > ${{targets.destdir}}/usr/bin/${{vars.output}}
      echo 'echo "go-build-test version: ${{package.version}}"' >> ${{targets.destdir}}/usr/bin/${{vars.output}}
      echo 'echo "build tags: ${{vars.tags}}"' >> ${{targets.destdir}}/usr/bin/${{vars.output}}
      chmod +x ${{targets.destdir}}/usr/bin/${{vars.output}}

      # Record embedded version info
      echo "version=${{package.version}}" > ${{targets.destdir}}/usr/share/go-build-test/version.txt
      echo "epoch=${{package.epoch}}" >> ${{targets.destdir}}/usr/share/go-build-test/version.txt
      echo "full-version=${{package.full-version}}" >> ${{targets.destdir}}/usr/share/go-build-test/version.txt

      echo "build-done" > ${{targets.destdir}}/usr/share/go-build-test/status.txt

  # Simulate multiple package build
  - name: go-build-multi
    runs: |
      # Simulate building multiple binaries
      mkdir -p ${{targets.destdir}}/usr/bin

      echo '#!/bin/sh' > ${{targets.destdir}}/usr/bin/${{vars.output}}-cli
      echo 'echo "${{vars.output}}-cli"' >> ${{targets.destdir}}/usr/bin/${{vars.output}}-cli
      chmod +x ${{targets.destdir}}/usr/bin/${{vars.output}}-cli

      echo '#!/bin/sh' > ${{targets.destdir}}/usr/bin/${{vars.output}}-server
      echo 'echo "${{vars.output}}-server"' >> ${{targets.destdir}}/usr/bin/${{vars.output}}-server
      chmod +x ${{targets.destdir}}/usr/bin/${{vars.output}}-server

      echo "multi-build-done" >> ${{targets.destdir}}/usr/share/go-build-test/status.txt

  # Simulate build with experiments
  - name: go-build-experiments
    runs: |
      # Record Go experiments configuration
      cat > ${{targets.destdir}}/usr/share/go-build-test/experiments.txt << 'EXP_EOF'
      Go experiments tested:
        GOEXPERIMENT=loopvar
        GOEXPERIMENT=rangefunc

      These experiments affect code generation and runtime behavior.
      EXP_EOF

      echo "experiments-done" >> ${{targets.destdir}}/usr/share/go-build-test/status.txt
