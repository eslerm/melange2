package:
  name: fetch-test
  version: 1.0.0
  epoch: 0
  description: Test fetch pipeline with checksum validation and archive extraction
  copyright:
    - license: MIT

pipeline:
  - name: setup
    runs: |
      mkdir -p ${{targets.destdir}}/usr/share/fetch-test
      mkdir -p /tmp/fetch-test

  - name: fetch-with-checksum
    runs: |
      # Test HTTP fetch with checksum validation
      # Download a small, stable file
      wget -q -O /tmp/fetch-test/downloaded.txt https://www.google.com/robots.txt
      test -f /tmp/fetch-test/downloaded.txt || exit 1

      # Calculate and store checksum (proves sha256sum works)
      sha256sum /tmp/fetch-test/downloaded.txt > /tmp/fetch-test/checksum.txt

      # Verify checksum file was created and has content
      test -s /tmp/fetch-test/checksum.txt || exit 1

      # Re-verify the file against stored checksum
      cd /tmp/fetch-test && sha256sum -c checksum.txt || exit 1

      cp /tmp/fetch-test/downloaded.txt ${{targets.destdir}}/usr/share/fetch-test/fetched.txt
      cp /tmp/fetch-test/checksum.txt ${{targets.destdir}}/usr/share/fetch-test/checksum.txt

  - name: create-test-archive
    runs: |
      # Create a test tarball to verify archive extraction
      mkdir -p /tmp/fetch-test/archive-source/subdir
      echo "file1 content" > /tmp/fetch-test/archive-source/file1.txt
      echo "file2 content" > /tmp/fetch-test/archive-source/subdir/file2.txt
      echo "file3 content" > /tmp/fetch-test/archive-source/subdir/file3.txt

      # Create tar.gz archive
      cd /tmp/fetch-test && tar -czf test-archive.tar.gz -C archive-source .
      test -f /tmp/fetch-test/test-archive.tar.gz || exit 1

  - name: extract-archive
    runs: |
      # Test archive extraction with tar
      mkdir -p /tmp/fetch-test/extracted
      tar -xzf /tmp/fetch-test/test-archive.tar.gz -C /tmp/fetch-test/extracted

      # Verify extracted files
      test -f /tmp/fetch-test/extracted/file1.txt || exit 1
      test -f /tmp/fetch-test/extracted/subdir/file2.txt || exit 1
      test -f /tmp/fetch-test/extracted/subdir/file3.txt || exit 1

      # Verify content
      grep -q "file1 content" /tmp/fetch-test/extracted/file1.txt || exit 1
      grep -q "file2 content" /tmp/fetch-test/extracted/subdir/file2.txt || exit 1

      # Copy results to output
      cp -r /tmp/fetch-test/extracted/* ${{targets.destdir}}/usr/share/fetch-test/

  - name: test-strip-components
    runs: |
      # Create a tarball with a top-level directory to test strip-components
      mkdir -p /tmp/fetch-test/to-strip/myproject/src
      echo "root file" > /tmp/fetch-test/to-strip/myproject/README.txt
      echo "source file" > /tmp/fetch-test/to-strip/myproject/src/main.txt
      cd /tmp/fetch-test/to-strip && tar -czf stripped-archive.tar.gz myproject

      # Extract with strip-components=1 to remove the myproject directory
      mkdir -p /tmp/fetch-test/stripped
      tar -xzf /tmp/fetch-test/to-strip/stripped-archive.tar.gz -C /tmp/fetch-test/stripped --strip-components=1

      # With strip-components=1, myproject/README.txt becomes README.txt
      test -f /tmp/fetch-test/stripped/README.txt || exit 1
      test -f /tmp/fetch-test/stripped/src/main.txt || exit 1

      echo "strip-components successful" > ${{targets.destdir}}/usr/share/fetch-test/strip-test.txt

  - name: verify-results
    runs: |
      # Final verification
      test -s ${{targets.destdir}}/usr/share/fetch-test/fetched.txt || exit 1
      test -s ${{targets.destdir}}/usr/share/fetch-test/checksum.txt || exit 1
      test -s ${{targets.destdir}}/usr/share/fetch-test/file1.txt || exit 1
      test -s ${{targets.destdir}}/usr/share/fetch-test/strip-test.txt || exit 1
      echo "all fetch tests passed" > ${{targets.destdir}}/usr/share/fetch-test/status.txt
